import"./hoisted.moGsIxmT.js";function m(o){return new Promise((i,t)=>{const e=document.createElement("script");e.src=o,e.onload=i,e.onerror=t,document.head.appendChild(e)})}await m("https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js");await m("https://cdnjs.cloudflare.com/ajax/libs/rickshaw/1.6.3/rickshaw.min.js");const v="https://cdn.jsdelivr.net/npm/p2p-media-loader-hlsjs@latest/build/p2p-media-loader-hlsjs.min.js",y="https://cdn.jsdelivr.net/npm/p2p-media-loader-shaka@latest/build/p2p-media-loader-shaka.min.js";function u(o,i){return new Promise(t=>{function e(){window[o]!==void 0&&(i===void 0||window[o][i]!==void 0)?t():setTimeout(e,200)}e()})}function P(o){return new Promise(i=>{function t(){try{i(require(o))}catch{setTimeout(t,200)}}t()})}function r(o){return new Promise((i,t)=>{const e=document.createElement("script");e.type="text/javascript",e.onload=()=>{i()},e.onerror=()=>{console.log("Failed to load script",o),t()},e.src=o,document.head.appendChild(e)})}function d(o){return new Promise((i,t)=>{const e=document.createElement("link");e.rel="stylesheet",e.type="text/css",e.onload=()=>{i()},e.onerror=()=>{console.log("Failed to load CSS",o),t()},e.href=o,document.head.appendChild(e)})}class g{async init(){await u("p2pml","core"),this.isP2PSupported=p2pml.core.HybridLoader.isSupported(),this.isP2PSupported||document.querySelector("#error-webrtc-data-channels").classList.remove("hide"),location.protocol=="https:"&&document.querySelector("#https-only").classList.remove("hide"),this.liveSyncDurationCount=7,this.initForm();var i=document.getElementById("videoUrlForm");this.videoUrl=i.url.value.trim(),this.playerType=i.type.value,this.videoContainer=document.getElementById("video_container"),this.loadSpeedTimespan=10;const t=await P("p2p-graph");this.graph=new t("#graph"),this.graph.add({id:"me",name:"You",me:!0}),await u("Rickshaw"),this.initChart(),this.restartDemo()}initForm(){var i=document.getElementById("videoUrlForm"),t=new URLSearchParams(document.location.search),e=t.get("url");e&&(i.url.value=e),e=t.get("type"),e&&(i.type.value=e),e=t.get("swarm"),e&&(this.swarmId=e),e=t.get("trackers"),e&&(this.trackers=e.split(","))}async restartDemo(){for(this.downloadStats=[],this.downloadTotals={http:0,p2p:0},this.uploadStats=[],this.uploadTotal=0;this.videoContainer.hasChildNodes();)this.videoContainer.removeChild(this.videoContainer.lastChild);const i={segments:{swarmId:this.swarmId},loader:{rtcConfig:{iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}],sdpSemantics:"unified-plan"}}};switch(this.trackers&&(i.loader.trackerAnnounce=this.trackers),this.playerType){case"hlsjs":case"clappr":case"flowplayer":case"mediaelement":case"videojs-contrib-hlsjs":case"videojs-hlsjs-plugin":case"dplayer":case"jwplayer":case"plyr":await r("https://cdn.jsdelivr.net/npm/hls.js@0.14.17"),Hls.isSupported()||document.querySelector("#error-hls-js").classList.remove("hide"),await r(v),this.engine=this.isP2PSupported?new p2pml.hlsjs.Engine(i):void 0;break;case"shakaplayer":case"dplayer-shaka":case"clappr-shaka":case"plyr-shaka":await Promise.all([r("https://github.com/videojs/mux.js/releases/download/v5.1.2/mux.js"),r("https://cdnjs.cloudflare.com/ajax/libs/shaka-player/2.5.1/shaka-player.compiled.js")]),shaka.polyfill.installAll(),shaka.Player.isBrowserSupported()||document.querySelector("#error-shakaplayer").classList.remove("hide"),await r(y),this.engine=this.isP2PSupported?new p2pml.shaka.Engine(i):void 0;break;default:console.error("Unexpected player type: ",this.playerType);return}switch(this.playerType){case"hlsjs":this.initHlsJsPlayer();break;case"clappr":this.initClapprPlayer();break;case"flowplayer":this.initFlowplayerPlayer();break;case"mediaelement":this.initMediaElementPlayer();break;case"videojs-contrib-hlsjs":this.initVideoJsContribHlsJsPlayer();break;case"videojs-hlsjs-plugin":this.initVideoJsHlsJsPlugin();break;case"jwplayer":this.initJwPlayer();break;case"dplayer":this.initDPlayerHlsJs();break;case"plyr":this.initPlyrPlayerHlsJs();break;case"shakaplayer":this.initShakaPlayer();break;case"clappr-shaka":this.initClapprPlayer(!0);break;case"dplayer-shaka":this.initDPlayerShaka();break;case"plyr-shaka":this.initPlyrPlayerShaka();break}if(this.isP2PSupported){this.engine.on(p2pml.core.Events.PieceBytesDownloaded,this.onBytesDownloaded.bind(this)),this.engine.on(p2pml.core.Events.PieceBytesUploaded,this.onBytesUploaded.bind(this));var t=this.engine.getSettings().loader.trackerAnnounce;Array.isArray(t)&&(document.getElementById("announce").innerHTML=t.join("<br />"))}this.refreshChart(),this.refreshGraph()}async initHlsJsPlayer(){if(Hls.isSupported()){var i=document.createElement("video");i.id="video",i.volume=0,i.setAttribute("playsinline",""),i.setAttribute("muted",""),i.setAttribute("autoplay",""),i.setAttribute("controls",""),this.videoContainer.appendChild(i);var t=document.createElement("select");t.id="level",t.classList.add("form-control"),this.videoContainer.appendChild(t);var e=new Hls({liveSyncDurationCount:this.liveSyncDurationCount,loader:this.isP2PSupported?this.engine.createLoaderClass():Hls.DefaultConfig.loader});this.isP2PSupported&&p2pml.hlsjs.initHlsJsPlayer(e),e.loadSource(this.videoUrl),e.attachMedia(i),e.on(Hls.Events.MANIFEST_PARSED,()=>{this.hlsLevelSwitcher.init(e,t)})}}async initClapprPlayer(i){const t=(async()=>{await r("https://cdn.jsdelivr.net/npm/clappr@latest"),await r("https://cdn.jsdelivr.net/gh/clappr/clappr-level-selector-plugin@latest/dist/level-selector.min.js")})();var e=document.createElement("div");e.className="embed-responsive embed-responsive-16by9";var a=document.createElement("div");a.id="video",a.className="embed-responsive-item",e.appendChild(a),this.videoContainer.appendChild(e);var s={parentId:"#video",plugins:[],source:this.videoUrl,width:"100%",height:"100%",muted:!0,mute:!0,autoPlay:!0,playback:{playInline:!0}};i?(await t,await r("https://cdn.jsdelivr.net/gh/clappr/dash-shaka-playback@latest/dist/dash-shaka-playback.external.js"),s.plugins.push(DashShakaPlayback),s.shakaOnBeforeLoad=l=>{this.isP2PSupported&&this.engine.initShakaPlayer(l)}):s.playback.hlsjsConfig={liveSyncDurationCount:this.liveSyncDurationCount,loader:this.isP2PSupported?this.engine.createLoaderClass():Hls.DefaultConfig.loader},await t,s.plugins.push(LevelSelector);var n=new Clappr.Player(s);!i&&this.isP2PSupported&&p2pml.hlsjs.initClapprPlayer(n)}async initMediaElementPlayer(){const i=r("https://cdnjs.cloudflare.com/ajax/libs/mediaelement/4.2.9/mediaelement-and-player.min.js");d("https://cdnjs.cloudflare.com/ajax/libs/mediaelement/4.2.9/mediaelementplayer.min.css");var t=document.createElement("video");t.id="video",t.volume=0,t.setAttribute("playsinline",""),t.setAttribute("muted",""),t.setAttribute("autoplay",""),this.videoContainer.appendChild(t),await i,mejs.Renderers.order=["native_hls"];var e=new MediaElementPlayer("video",{stretching:"responsive",startVolume:0,hls:{liveSyncDurationCount:this.liveSyncDurationCount,loader:this.isP2PSupported?this.engine.createLoaderClass():Hls.DefaultConfig.loader},success:a=>{this.isP2PSupported&&p2pml.hlsjs.initMediaElementJsPlayer(a)}});e.setSrc(this.videoUrl),e.load(),e.play()}async initFlowplayerPlayer(){const i=r("https://releases.flowplayer.org/7.2.7/flowplayer.min.js");d("https://releases.flowplayer.org/7.2.7/skin/skin.css");var t=document.createElement("div");t.id="video",t.className="fp-slim",this.videoContainer.appendChild(t),await i;var e=flowplayer("#video",{autoplay:!0,muted:!0,live:!0,clip:{sources:[{type:"application/x-mpegurl",src:this.videoUrl}]},hlsjs:{liveSyncDurationCount:this.liveSyncDurationCount,loader:this.isP2PSupported?this.engine.createLoaderClass():Hls.DefaultConfig.loader,safari:!0}});this.isP2PSupported&&p2pml.hlsjs.initFlowplayerHlsJsPlayer(e)}async initVideoJsContribHlsJsPlayer(){const i=(async()=>{await r("https://vjs.zencdn.net/7.6.0/video.js"),await r("https://cdn.jsdelivr.net/npm/videojs-contrib-hls.js@latest")})();d("https://vjs.zencdn.net/7.6.0/video-js.css");var t=document.createElement("div");t.className="embed-responsive embed-responsive-16by9";var e=document.createElement("video");e.id="video",e.preload="none",e.className="embed-responsive-item video-js vjs-default-skin",e.volume=0,e.setAttribute("playsinline",""),e.setAttribute("muted",""),e.setAttribute("autoplay",""),e.setAttribute("controls",""),t.appendChild(e),this.videoContainer.appendChild(t),await i;var a=videojs("video",{html5:{hlsjsConfig:{liveSyncDurationCount:this.liveSyncDurationCount,loader:this.isP2PSupported?this.engine.createLoaderClass():Hls.DefaultConfig.loader}}});this.isP2PSupported&&p2pml.hlsjs.initVideoJsContribHlsJsPlayer(a),a.src({type:"application/x-mpegURL",src:this.videoUrl}),a.ready(()=>{a.volume(0),a.play()})}async initVideoJsHlsJsPlugin(){const i=(async()=>{await r("https://vjs.zencdn.net/7.6.0/video.js"),await Promise.all([r("https://cdn.streamroot.io/videojs-hlsjs-plugin/1/stable/videojs-hlsjs-plugin.js"),r("https://cdn.jsdelivr.net/npm/videojs-contrib-quality-levels@latest/dist/videojs-contrib-quality-levels.min.js"),r("https://cdn.jsdelivr.net/npm/videojs-http-source-selector@latest/dist/videojs-http-source-selector.js")])})();d("https://vjs.zencdn.net/7.6.0/video-js.css");var t=document.createElement("div");t.className="embed-responsive embed-responsive-16by9";var e=document.createElement("video");e.id="video",e.className="embed-responsive-item video-js vjs-default-skin",e.setAttribute("muted",""),e.setAttribute("autoplay",""),e.setAttribute("controls",""),t.appendChild(e),this.videoContainer.appendChild(t),await i,this.isP2PSupported&&p2pml.hlsjs.initVideoJsHlsJsPlugin();var a=videojs("video",{html5:{hlsjsConfig:{liveSyncDurationCount:this.liveSyncDurationCount,loader:this.isP2PSupported?this.engine.createLoaderClass():Hls.DefaultConfig.loader}}});a.httpSourceSelector(),a.src({src:this.videoUrl,type:"application/x-mpegURL"})}async initJwPlayer(){const i=Promise.all([r("https://content.jwplatform.com/libraries/aG3IMhIy.js"),r("https://cdn.jsdelivr.net/npm/@hola.org/jwplayer-hlsjs@latest/dist/jwplayer.hlsjs.min.js")]);var t=document.createElement("div");t.id="video",t.volume=0,t.setAttribute("playsinline",""),t.setAttribute("muted",""),t.setAttribute("autoplay",""),this.videoContainer.appendChild(t),await i;var e=jwplayer("video");e.setup({file:this.videoUrl,mute:!0}),jwplayer_hls_provider.attach(),this.isP2PSupported&&p2pml.hlsjs.initJwPlayer(e,{liveSyncDurationCount:this.liveSyncDurationCount,loader:this.engine.createLoaderClass()})}async initDPlayerHlsJs(){if(!Hls.isSupported())return;const i=r("https://cdn.jsdelivr.net/npm/dplayer@latest");d("https://cdn.jsdelivr.net/npm/p2p-dplayer@latest/dist/DPlayer.min.css");var t=document.createElement("div");t.id="dplayer",this.videoContainer.appendChild(t),await i,window.dp=new DPlayer({container:document.getElementById("dplayer"),video:{url:this.videoUrl,type:"customHls",customType:{customHls:e=>{const a=new Hls({liveSyncDurationCount:7,loader:this.engine.createLoaderClass()});p2pml.hlsjs.initHlsJsPlayer(a),a.loadSource(e.src),a.attachMedia(e)}}}})}async initDPlayerShaka(){if(!shaka.Player.isBrowserSupported())return;const i=r("https://cdn.jsdelivr.net/npm/dplayer@latest");d("https://cdn.jsdelivr.net/npm/p2p-dplayer@latest/dist/DPlayer.min.css");var t=document.createElement("div");t.id="dplayer",this.videoContainer.appendChild(t),await i,window.dp=new DPlayer({container:document.getElementById("dplayer"),video:{url:this.videoUrl,type:"customHlsOrDash",customType:{customHlsOrDash:e=>{const a=e.src,s=new shaka.Player(e),n=function(l){console.error("Error code",l.code,"object",l)};s.addEventListener("error",function(l){n(l.detail)}),this.engine.initShakaPlayer(s),s.load(a).catch(n)}}}})}initShakaPlayer(){if(shaka.Player.isBrowserSupported()){var i=document.createElement("video");i.id="video",i.volume=0,i.setAttribute("playsinline",""),i.setAttribute("muted",""),i.setAttribute("autoplay",""),i.setAttribute("controls",""),this.videoContainer.appendChild(i);var t=document.createElement("select");t.id="level",t.classList.add("form-control"),this.videoContainer.appendChild(t);var e=new shaka.Player(i);this.isP2PSupported&&this.engine.initShakaPlayer(e),this.shakaLevelSwitcher.init(e,t),e.load(this.videoUrl)}}async initPlyrPlayerHlsJs(){if(!Hls.isSupported())return;const i=r("https://cdn.plyr.io/3.5.6/plyr.js");d("https://cdn.plyr.io/3.5.6/plyr.css");var t=document.createElement("video");t.id="video",t.setAttribute("muted",""),t.setAttribute("autoplay",""),t.setAttribute("controls",""),this.videoContainer.appendChild(t);var e=document.createElement("select");e.id="level",e.classList.add("form-control"),this.videoContainer.appendChild(e),await i,new Plyr(t,{captions:{active:!0,update:!0}});var a=new Hls({liveSyncDurationCount:this.liveSyncDurationCount,loader:this.isP2PSupported?this.engine.createLoaderClass():Hls.DefaultConfig.loader});this.isP2PSupported&&p2pml.hlsjs.initHlsJsPlayer(a),a.loadSource(this.videoUrl),a.attachMedia(t),a.on(Hls.Events.MANIFEST_PARSED,()=>{this.hlsLevelSwitcher.init(a,e)})}async initPlyrPlayerShaka(){if(!shaka.Player.isBrowserSupported())return;const i=r("https://cdn.plyr.io/3.5.6/plyr.js");d("https://cdn.plyr.io/3.5.6/plyr.css");var t=document.createElement("video");t.id="video",t.volume=0,t.setAttribute("muted",""),t.setAttribute("autoplay",""),t.setAttribute("controls",""),this.videoContainer.appendChild(t);var e=document.createElement("select");e.id="level",e.classList.add("form-control"),this.videoContainer.appendChild(e),await i,new Plyr(t);var a=new shaka.Player(t);this.isP2PSupported&&this.engine.initShakaPlayer(a),this.shakaLevelSwitcher.init(a,e),a.load(this.videoUrl)}initChart(){var i={element:document.querySelector("#chart"),renderer:"multi",interpolation:"basis",stack:!1,min:"auto",strokeWidth:1,series:[{name:"Upload P2P",color:"#88eab9",data:[],renderer:"area"},{name:" - P2P",color:"#88b9ea",data:[],renderer:"area"},{name:" - HTTP",color:"#eae288",data:[],renderer:"area"},{name:"Download",color:"#f64",data:[],renderer:"line"}]};this.chart=new Rickshaw.Graph(i),new Rickshaw.Graph.Axis.X({graph:this.chart,tickFormat:()=>""}),new Rickshaw.Graph.Axis.Y({graph:this.chart,orientation:"left",element:document.getElementById("y_axis")}),this.legend=new Rickshaw.Graph.Legend({graph:this.chart,element:document.getElementById("legend")}),this.legendTotals=new Rickshaw.Graph.Legend({graph:this.chart,element:document.getElementById("legend-totals")}),this.chart.render(),setInterval(this.updateChartData.bind(this),500);var t=()=>{i.width=this.chart.element.clientWidth,this.chart.configure(i),this.chart.render()};t(),window.addEventListener("resize",t)}refreshChart(){if(this.chart){var i=this.chart.series[0].data,t=this.chart.series[1].data,e=this.chart.series[2].data,a=this.chart.series[3].data,s=i.length>0?i[i.length-1].x:-1,n=(c,h)=>({x:h+s+1,y:0});i.length=0,t.length=0,e.length=0,a.length=0;var l=Array.apply(null,Array(200)).map(n);i.push.apply(i,l.slice(0)),t.push.apply(t,l.slice(0)),e.push.apply(e,l.slice(0)),a.push.apply(a,l.slice(0)),this.chart.update()}}updateChartData(){var i=this.getDownloadSpeed(),t=Number((i.http*8/1e6).toFixed(2)),e=Number((i.p2p*8/1e6).toFixed(2)),a=Number((t+e).toFixed(2)),s=Number(this.getUploadSpeed()*8/1e6).toFixed(2),n=this.chart.series[0].data,l=this.chart.series[1].data,c=this.chart.series[2].data,h=this.chart.series[3].data,p=n.length>0?n[n.length-1].x+1:0;n.shift(),l.shift(),c.shift(),h.shift(),n.push({x:p,y:-s}),l.push({x:p,y:a}),c.push({x:p,y:t}),h.push({x:p,y:a}),this.chart.update(),this.formatChartLegendLine(0,a),this.formatChartLegendLine(1,t),this.formatChartLegendLine(2,e),this.formatChartLegendLine(3,s),this.updateLegendTotals()}formatChartLegendLine(i,t){if(this.legend){var e=this.legend.lines[i];e.element.childNodes[1].textContent=e.series.name+" - "+t+" Mbit/s"}}updateLegendTotals(){if(this.legendTotals){var i=this.downloadTotals.http/1048576,t=this.downloadTotals.p2p/1048576,e=i+t,a=this.uploadTotal/1048576;e!=0&&(this.legendTotals.lines[0].element.childNodes[1].textContent="Download - "+Number(e).toFixed(1)+" MiB",this.legendTotals.lines[1].element.childNodes[1].textContent=" - HTTP - "+Number(i).toFixed(1)+" MiB - "+Number(i*100/e).toFixed(0)+"%",this.legendTotals.lines[2].element.childNodes[1].textContent=" - P2P - "+Number(t).toFixed(1)+" MiB - "+Number(t*100/e).toFixed(0)+"%",this.legendTotals.lines[3].element.childNodes[1].textContent="Upload P2P - "+Number(a).toFixed(1)+" MiB")}}getDownloadSpeed(){for(var i=performance.now()-this.loadSpeedTimespan*1e3,t=0,e=0,a=this.downloadStats.length;a--;){var s=this.downloadStats[a];if(s.timestamp<i)break;s.method==="p2p"?e+=s.size:s.method==="http"&&(t+=s.size)}return this.downloadStats.splice(0,a+1),{p2p:e/this.loadSpeedTimespan,http:t/this.loadSpeedTimespan}}getUploadSpeed(){for(var i=performance.now()-this.loadSpeedTimespan*1e3,t=0,e=this.uploadStats.length;e--;){var a=this.uploadStats[e];if(a.timestamp<i)break;t+=a.size}return this.uploadStats.splice(0,e+1),t/this.loadSpeedTimespan}onBytesDownloaded(i,t){this.downloadStats.push({method:i,size:t,timestamp:performance.now()}),this.downloadTotals[i]+=t}onBytesUploaded(i,t){this.uploadStats.push({size:t,timestamp:performance.now()}),this.uploadTotal+=t}refreshGraph(){if(this.graph){for(var i=this.graph.list(),t=0;t<i.length;t++)i[t].id!=="me"&&(this.graph.disconnect("me",i[t].id),this.graph.remove(i[t].id));this.isP2PSupported&&(this.engine.on(p2pml.core.Events.PeerConnect,this.onPeerConnect.bind(this)),this.engine.on(p2pml.core.Events.PeerClose,this.onPeerClose.bind(this)))}}onPeerConnect(i){this.graph.hasPeer(i.id)||(this.graph.add({id:i.id,name:i.remoteAddress||"Unknown"}),this.graph.connect("me",i.id))}onPeerClose(i){this.graph.hasPeer(i)&&(this.graph.disconnect("me",i),this.graph.remove(i))}constructor(){this.hlsLevelSwitcher={auto:"Auto",hls:void 0,select:void 0,init:function(i,t){if(i.levelController.levels.length<2){t.style.display="none";return}else t.style.display="block";this.hls=i,this.select=t,this._clearOptions(),this._addOption(this.auto),i.levelController.levels.forEach((e,a)=>{var s=[];e.height&&s.push(e.height+"p"),e.bitrate&&s.push(Math.round(e.bitrate/1e3)+"k"),s.length===0&&s.push("Quality #"+a),this._addOption(s.join(" / "),a)}),i.on(Hls.Events.LEVEL_SWITCHED,this._hlsLevelSwitch.bind(this)),this.select.addEventListener("change",e=>{i.nextLevel=e.target.selectedIndex-1,this._hlsLevelSwitch()})},_hlsLevelSwitch:function(){var i=this.select.querySelector("option:not([data-index])"),t=this.select.querySelector("option[data-index='"+this.hls.currentLevel+"']");this.hls.autoLevelEnabled||this.hls.currentLevel===-1?(i.selected=!0,i.text=t?t.text+" ("+this.auto+")":this.auto):(t.selected=!0,i.text=this.auto)},_clearOptions:function(){for(;this.select.options.length;)this.select.remove(0)},_addOption:function(i,t){var e=document.createElement("option");e.text=i,t!==void 0&&(e.dataset.index=t),this.select.add(e)}},this.shakaLevelSwitcher={auto:"Auto",player:void 0,select:void 0,init:function(i,t){this.player=i,this.select=t,i.addEventListener("trackschanged",()=>{this._clearOptions(),this._addOption(this.auto),this.player.getVariantTracks().forEach((e,a)=>{var s=[];e.height&&s.push(e.height+"p"),e.bandwidth&&s.push(Math.round(e.bandwidth/1e3)+"k"),e.label?s.push(e.label):e.language&&s.push(e.language),s.length===0&&s.push("Variant #"+a),this._addOption(s.join(" / "),e.id)})}),i.addEventListener("adaptation",()=>{var e=this.player.getVariantTracks().find(n=>n.active===!0).id,a=this.select.querySelector("option[data-variant-id='"+e+"']"),s=this.select.querySelector("option:not([data-variant-id])");s.text=a?a.text+" ("+this.auto+")":this.auto}),t.addEventListener("change",()=>{var e=this.select.selectedOptions[0].dataset.variantId;if(e){var a=this.player.getVariantTracks().find(n=>n.id==e);this.player.configure({abr:{enabled:!1}}),this.player.selectVariantTrack(a);var s=this.select.querySelector("option:not([data-variant-id])");s.text=this.auto}else this.player.configure({abr:{enabled:!0}})})},_clearOptions:function(){for(;this.select.options.length;)this.select.remove(0)},_addOption:function(i,t){var e=document.createElement("option");e.text=i,t&&(e.dataset.variantId=t),this.select.add(e)}}}}const f=new g;f.init();
